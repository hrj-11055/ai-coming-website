<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·åœ°ç†ä½ç½®ç»Ÿè®¡ - AIèµ„è®¯ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 36px;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .logs-table {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .logs-table h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f7f7f7;
            font-weight: 600;
            color: #333;
        }

        td {
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f7f7f7;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .province-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 350px;
            }

            .controls {
                flex-direction: column;
            }

            .btn, .select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <a href="admin-ipban.html" class="back-link" style="margin-left: 20px;">ğŸ”’ IPå°ç¦ç®¡ç†</a>
        <a href="#" class="back-link" onclick="logout()" style="margin-left: 20px;">é€€å‡ºç™»å½•</a>

        <div class="header">
            <h1>ç”¨æˆ·åœ°ç†ä½ç½®ç»Ÿè®¡</h1>
            <p>å®æ—¶æŸ¥çœ‹ç”¨æˆ·è®¿é—®åˆ†å¸ƒæƒ…å†µå’Œè¯¦ç»†è®¿é—®æ—¥å¿—</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>æ€»è®¿é—®é‡</h3>
                <div class="value" id="totalVisits">-</div>
            </div>
            <div class="stat-card">
                <h3>è¦†ç›–çœä»½æ•°</h3>
                <div class="value" id="provinceCount">-</div>
            </div>
            <div class="stat-card">
                <h3>æœ€æ´»è·ƒçœä»½</h3>
                <div class="value" id="topProvince" style="font-size: 24px;">-</div>
            </div>
            <div class="stat-card">
                <h3>ä»Šæ—¥è®¿é—®</h3>
                <div class="value" id="todayVisits">-</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>çœä»½è®¿é—®åˆ†å¸ƒ</h2>
            <div class="controls">
                <button class="btn btn-primary" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-danger" onclick="cleanupLogs()">æ¸…ç†æ—§æ—¥å¿—</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="provinceChart"></canvas>
            </div>
        </div>

        <div class="logs-table">
            <h2>è¯¦ç»†è®¿é—®æ—¥å¿—</h2>
            <div class="controls">
                <select class="select" id="provinceFilter" onchange="loadLogs(1)">
                    <option value="all">æ‰€æœ‰çœä»½</option>
                </select>
                <button class="btn btn-primary" onclick="loadLogs(1)">æŸ¥è¯¢</button>
            </div>
            <div id="logsContainer">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        let provinceChart = null;
        let authToken = localStorage.getItem('admin_token');

        // æ³¨å†Œ Chart.js æ•°æ®æ ‡ç­¾æ’ä»¶
        Chart.register(ChartDataLabels);

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            if (!authToken) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = 'admin-login.html?return=' + encodeURIComponent(window.location.href);
                return;
            }

            loadProvinceStats();
            loadLogs(1);
        });

        // åŠ è½½çœä»½ç»Ÿè®¡æ•°æ®
        async function loadProvinceStats() {
            try {
                const response = await fetch('/api/visit/province-stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateStats(data);
                    renderChart(data.provinceStats);
                    updateProvinceFilter(data.provinceStats);
                } else if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('admin_token');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥');
            }
        }

        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStats(data) {
            document.getElementById('totalVisits').textContent = data.total;
            document.getElementById('provinceCount').textContent = data.provinceStats.length;

            if (data.provinceStats.length > 0) {
                document.getElementById('topProvince').textContent = data.provinceStats[0].province;
            } else {
                document.getElementById('topProvince').textContent = 'æš‚æ— æ•°æ®';
            }

            // è®¡ç®—ä»Šæ—¥è®¿é—®
            const today = new Date().toISOString().split('T')[0];
            const todayCount = data.provinceStats.reduce((sum, stat) => {
                // è¿™é‡Œéœ€è¦ä»è¯¦ç»†æ—¥å¿—ä¸­ç»Ÿè®¡ï¼Œæš‚æ—¶æ˜¾ç¤ºæ€»æ•°
                return sum + stat.count;
            }, 0);
            document.getElementById('todayVisits').textContent = todayCount;
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(provinceStats) {
            const ctx = document.getElementById('provinceChart').getContext('2d');

            // é”€æ¯æ—§å›¾è¡¨
            if (provinceChart) {
                provinceChart.destroy();
            }

            // å‡†å¤‡æ•°æ®ï¼ˆåªæ˜¾ç¤ºå‰15ä¸ªçœä»½ï¼‰
            const topStats = provinceStats.slice(0, 15);
            const labels = topStats.map(s => s.province);
            const values = topStats.map(s => s.count);

            // ç”Ÿæˆé¢œè‰²
            const colors = generateColors(values.length);

            provinceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è®¿é—®é‡',
                        data: values,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} æ¬¡è®¿é—®`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#333',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function(value) {
                                return value;
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆé¢œè‰²æ•°ç»„
        function generateColors(count) {
            const baseColors = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(237, 100, 166, 0.8)',
                'rgba(255, 154, 158, 0.8)',
                'rgba(250, 208, 196, 0.8)',
                'rgba(161, 196, 253, 0.8)',
                'rgba(194, 233, 251, 0.8)',
                'rgba(42, 157, 143, 0.8)',
                'rgba(0, 180, 216, 0.8)',
                'rgba(106, 176, 76, 0.8)',
                'rgba(203, 214, 46, 0.8)',
                'rgba(255, 160, 0, 0.8)',
                'rgba(255, 87, 51, 0.8)',
                'rgba(255, 71, 87, 0.8)',
                'rgba(155, 89, 182, 0.8)'
            ];

            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        // æ›´æ–°çœä»½ç­›é€‰å™¨
        function updateProvinceFilter(provinceStats) {
            const select = document.getElementById('provinceFilter');
            select.innerHTML = '<option value="all">æ‰€æœ‰çœä»½</option>';

            provinceStats.forEach(stat => {
                const option = document.createElement('option');
                option.value = stat.province;
                option.textContent = `${stat.province} (${stat.count})`;
                select.appendChild(option);
            });
        }

        // åŠ è½½è®¿é—®æ—¥å¿—
        async function loadLogs(page = 1) {
            try {
                const province = document.getElementById('provinceFilter').value;
                const url = `/api/visit/logs?page=${page}&limit=20&province=${province}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderLogs(data.logs);
                    renderPagination(data.pagination);
                } else if (response.status === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('admin_token');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                document.getElementById('logsContainer').innerHTML = '<div class="no-data">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“æ—¥å¿—è¡¨æ ¼
        function renderLogs(logs) {
            const container = document.getElementById('logsContainer');

            if (logs.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— è®¿é—®æ—¥å¿—</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>IPåœ°å€</th>
                            <th>çœä»½</th>
                            <th>å›½å®¶</th>
                            <th>ç”¨æˆ·ä»£ç†</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td>${formatDate(log.date)}</td>
                                <td>${maskIP(log.ip)}</td>
                                <td><span class="province-tag">${log.province}</span></td>
                                <td>${log.country}</td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${log.userAgent}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            const container = document.getElementById('logsContainer');
            const { page, totalPages } = pagination;

            if (totalPages <= 1) return;

            let html = '<div class="pagination">';

            // ä¸Šä¸€é¡µ
            if (page > 1) {
                html += `<button onclick="loadLogs(${page - 1})">ä¸Šä¸€é¡µ</button>`;
            }

            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === page) {
                    html += `<button class="active">${i}</button>`;
                } else {
                    html += `<button onclick="loadLogs(${i})">${i}</button>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            if (page < totalPages) {
                html += `<button onclick="loadLogs(${page + 1})">ä¸‹ä¸€é¡µ</button>`;
            }

            html += '</div>';
            container.innerHTML += html;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // æ©ç IPåœ°å€
        function maskIP(ip) {
            if (ip === 'æœªçŸ¥') return ip;
            const parts = ip.split('.');
            if (parts.length === 4) {
                return `${parts[0]}.${parts[1]}.***.***`;
            }
            return ip;
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadProvinceStats();
            loadLogs(1);
        }

        // æ¸…ç†æ—§æ—¥å¿—
        async function cleanupLogs() {
            const days = prompt('è¯·è¾“å…¥è¦ä¿ç•™çš„å¤©æ•°ï¼ˆé»˜è®¤30å¤©ï¼‰:', '30');
            if (!days) return;

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${days} å¤©å‰çš„æ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`/api/visit/logs/cleanup?days=${days}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`æ¸…ç†æˆåŠŸï¼åˆ é™¤äº† ${data.deleted} æ¡è®°å½•`);
                    refreshData();
                } else {
                    alert('æ¸…ç†å¤±è´¥');
                }
            } catch (error) {
                console.error('æ¸…ç†æ—¥å¿—å¤±è´¥:', error);
                alert('æ¸…ç†å¤±è´¥');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                window.location.href = 'admin-login.html';
            }
        }
    </script>
</body>
</html>
